# Azure DevOps Pipeline Configuration
# This pipeline automatically triggers when changes are pushed to the main branch on GitHub
# It builds Docker images and deploys to Azure using FREE tier services

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md
      - docs/*
      - '*.md'

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Azure Container Registry (Free tier: 500MB storage, 10K pulls/day)
  dockerRegistryServiceConnection: 'ACR-Connection'  # Create this service connection
  containerRegistry: '$(ACR_NAME).azurecr.io'
  imageRepository: 'university-app'
  
  # Azure App Service names (Free tier F1 available)
  # Change these to match your App Service names in Azure
  apiAppName: 'university-app-api'
  frontendAppName: 'university-app-frontend'
  
  # Image tags
  dockerfilePath: '$(Build.SourcesDirectory)/university_app'
  tag: '$(Build.BuildId)'

stages:
  - stage: Build
    displayName: 'Build Docker Images'
    jobs:
      - job: BuildImages
        displayName: 'Build and Push Images'
        steps:
          - checkout: self
            displayName: 'Checkout code from GitHub'
            fetchDepth: 1

          - script: |
              echo "Repository: $(Build.Repository.Name)"
              echo "Branch: $(Build.SourceBranch)"
              echo "Commit: $(Build.SourceVersion)"
              echo "Building images for Azure deployment..."
            displayName: 'Display build information'

          # Build and push API image
          - task: Docker@2
            displayName: 'Build and Push API Image'
            inputs:
              command: buildAndPush
              repository: $(imageRepository)-api
              dockerfile: '$(dockerfilePath)/api/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest

          # Build and push Frontend image
          - task: Docker@2
            displayName: 'Build and Push Frontend Image'
            inputs:
              command: buildAndPush
              repository: $(imageRepository)-app
              dockerfile: '$(dockerfilePath)/app/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              buildContext: '$(dockerfilePath)/app'
              tags: |
                $(tag)
                latest
              arguments: '--build-arg VITE_API_URL=https://$(apiAppName).azurewebsites.net'
            
            # Note: If VITE_API_URL needs to be set at runtime, remove the build arg above
            # and set it as an environment variable in the App Service instead

  - stage: Deploy
    displayName: 'Deploy to Azure (Free Tier)'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployToAzure
        displayName: 'Deploy Application to Azure'
        environment: 'production'  # Create this environment in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                # Deploy API to Azure App Service (Free tier)
                - task: AzureWebAppContainer@1
                  displayName: 'Deploy API to Azure App Service'
                  inputs:
                    azureSubscription: 'Azure-Subscription'  # Create this service connection
                    appName: '$(apiAppName)'
                    containers: '$(containerRegistry)/$(imageRepository)-api:$(tag)'
                    appSettings: |
                      -DATABASE_URL $(DATABASE_URL)
                      -PYTHONUNBUFFERED 1
                      -PYTHONDONTWRITEBYTECODE 1
                
                # Deploy Frontend to Azure App Service (Free tier)
                - task: AzureWebAppContainer@1
                  displayName: 'Deploy Frontend to Azure App Service'
                  inputs:
                    azureSubscription: 'Azure-Subscription'
                    appName: '$(frontendAppName)'
                    containers: '$(containerRegistry)/$(imageRepository)-app:$(tag)'
                    appSettings: |
                      -VITE_API_URL https://$(apiAppName).azurewebsites.net

                - script: |
                    echo "## Deployment Complete!"
                    echo "Frontend URL: https://$(frontendAppName).azurewebsites.net"
                    echo "API URL: https://$(apiAppName).azurewebsites.net"
                    echo "API Docs: https://$(apiAppName).azurewebsites.net/docs"
                  displayName: 'Display Deployment URLs'
